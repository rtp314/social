import{r as c,v as R,x as _,w as b,i as q,e as N,j as h,a,d as J,f as V,b as L,F as D,U as W,l as X,m as S,n as I}from"./index.88d996d1.js";function z(){const e=c.exports.useRef(),s=c.exports.useRef(),i=c.exports.useRef(),f=(p,l)=>(s.current=p,i.current=l,e.current=setTimeout(s.current,l),e.current),o=()=>{e.current&&clearTimeout(e.current)};return{timeout:f,cancel:o,reset:()=>{s.current&&i.current&&(o(),f(s.current,i.current))}}}function G(e){const[s,i]=c.exports.useState([[]]),[f,o]=c.exports.useState(!0),m=c.exports.useRef();function p(u){if(u.length===0)return[[]];const r=[[u[0]]];let d=0;return u.forEach((g,n)=>{n!==0&&(g.day===r[d][0].day?r[d].push(g):(d++,r.push([g])))}),r}function l(u){u[0].length!==0&&i(r=>{if(r[0][0]===void 0)return u;if(u[0][0].day===r[r.length-1][0].day){const d=[...r];return d[d.length-1].push(...u[0]),d.push(...u.slice(1)),d}else return[...r,...u]})}return c.exports.useEffect(()=>{e!==m.current&&(i([[]]),m.current=e),o(!0);const u=R(b(N,"chats",e,"messages"),_("date","asc")),r=q(u,d=>{const g=d.docChanges().filter(n=>n.type==="added").map(n=>n.doc.data()).map(n=>({...n,day:n.date.toDate().toDateString(),time:n.date.toDate().toTimeString().slice(0,5)}));l(p(g)),o(!1)},d=>console.log(d));return()=>r()},[e]),[f,s]}function H({user:e,msg:s}){return h("div",{className:e!==s.uid?"sentMsg msg":"receivedMsg msg",children:[e===s.uid||JSON.stringify(s.name),a("span",{className:"timestamp",children:s.time}),s.msg]})}function K({msgGroup:e,user:s}){return h("div",{className:"messagegroup",children:[a("span",{className:"timestamp",children:e[0].day}),e.map(i=>a(H,{msg:i,user:s}))]})}function P({chatID:e}){const[s,i]=c.exports.useState("");async function f(o){var p;o.preventDefault();const m=s;i(""),await J(b(N,"chats",e,"messages"),{date:V.now(),msg:m,uid:(p=L.currentUser)==null?void 0:p.uid})}return a("div",{className:"chat-writer",children:h("form",{onSubmit:f,children:[a("input",{type:"text",value:s,onChange:o=>i(o.target.value),placeholder:"Type your message here"}),a("button",{className:"button primary",type:"submit",children:"Send"})]})})}function Q({chatID:e,chatName:s,setOpenChatBox:i}){const[f,o]=G(e),[m,p]=c.exports.useState(!0);return c.exports.useEffect(()=>{var l;m===!0&&((l=document.getElementById("chatBottom"))==null||l.scrollIntoView({behavior:"auto"}))},[o,m]),h("div",{className:"chatbox",children:[h("div",{className:"flex-between",onClick:()=>p(l=>!l),children:[a("div",{children:s}),m&&a("div",{className:"close",onClick:()=>i(!1),children:"X"})]}),m&&h(D,{children:[h("div",{className:"chat-messages",children:[f?"Loading messages":o[0].length!==0&&o.map((l,u)=>{var r;return a(K,{user:((r=L.currentUser)==null?void 0:r.uid)||"unknown",msgGroup:l},u)}),a("div",{id:"chatBottom"})]}),a(P,{chatID:e})]})]})}const Y="/images/message-svgrepo-com.svg";function $(){var k;const e=((k=L.currentUser)==null?void 0:k.uid)||"",[s,i]=c.exports.useState(!1),[f,o]=c.exports.useState(!1),{timeout:m}=z(),[p,l]=c.exports.useState([]),[u,r]=c.exports.useState(""),[d,g]=c.exports.useState(""),n=c.exports.useContext(W),v=c.exports.useRef(null),y=c.exports.useRef(null);async function E(){const t=R(b(N,"users",e,"chats")),x=await X(t);let w=[];x.forEach(C=>{let M=C.data(),F=C.id;w.push({uid:F,chatID:M.chat_id})}),l(w)}async function j(t){var w;if(!n)return;(w=v.current)==null||w.close();const x=p.find(C=>C.uid===t);if(x!==void 0)r(x.chatID),g(n.friends[t]),i(!0);else{console.log("creating new chat document");const C=S(b(N,"chats")).id;await I(S(N,"users",e,"chats",t),{chat_id:C,users:[e,t]}),await I(S(N,"users",t,"chats",e),{chat_id:C,users:[e,t]}),r(C),l(M=>[...M,{uid:t,chatID:C}]),g(n.friends[t]),i(!0)}}function B(t){!n||(r(t.chatID),g(n.friends[t.uid]),i(!0))}function O(){v.current&&typeof v.current.showModal=="function"&&v.current.showModal()}function T(){y.current&&(y.current.classList.add("circle-animate"),m(()=>{var t;return(t=y.current)==null?void 0:t.classList.remove("circle-animate")},700))}function U(){f===!1?(T(),o(!0)):o(!1)}return c.exports.useEffect(()=>{E()},[]),n===void 0?a("div",{children:"Error"}):h(D,{children:[h("div",{id:"friends-list",children:[h("h3",{className:"align-center",onClick:U,children:[a("img",{id:"message-icon",src:Y,alt:"messages"}),a("div",{className:"circle",ref:y}),h("span",{children:["\xA0",f?"Chats":"Open Chat"]})]}),f&&h(D,{children:[a("div",{className:"highlight secondary",onClick:O,children:"New Chat"}),h("dialog",{className:"modal",ref:v,children:[a("h3",{children:"Friends"}),typeof n.friends=="object"&&Object.keys(n.friends).map((t,x)=>a("div",{className:"highlight",onClick:()=>j(t),children:n.friends[t]},x)),a("button",{value:"cancel",onClick:()=>{var t;return(t=v.current)==null?void 0:t.close()},children:"Cancel"})]}),typeof n.friends=="object"&&p.length>0&&p.map((t,x)=>a("div",{className:"highlight",onClick:()=>B(t),children:n.friends[t.uid]},x))]})]}),s&&a(Q,{chatID:u,chatName:d,setOpenChatBox:i})]})}export{$ as default};
