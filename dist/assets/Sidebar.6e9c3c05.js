import{v as R,U,R as b,y as _,t as q,u as P,x as J,P as S,s as D}from"./firestore.0b02de5c.js";import{r,d as N,j as f,a as n,b as k,F as L}from"./index.e531dfa1.js";import{m as C,a as w}from"./currentUserData.dabfcea3.js";function V(){const s=r.exports.useRef(),t=r.exports.useRef(),c=r.exports.useRef(),p=(g,h)=>(t.current=g,c.current=h,s.current=setTimeout(t.current,h),s.current),u=()=>{s.current&&clearTimeout(s.current)};return{timeout:p,cancel:u,reset:()=>{t.current&&c.current&&(u(),p(t.current,c.current))}}}function W(s){const[t,c]=r.exports.useState([[]]),[p,u]=r.exports.useState(!0),l=r.exports.useRef();function g(a){if(a.length===0)return[[]];const i=[[a[0]]];let o=0;return a.forEach((m,d)=>{d!==0&&(m.day===i[o][0].day?i[o].push(m):(o++,i.push([m])))}),i}function h(a){a[0].length!==0&&c(i=>{if(i[0][0]===void 0)return a;if(a[0][0].day===i[i.length-1][0].day){const o=[...i];return o[o.length-1].push(...a[0]),o.push(...a.slice(1)),o}else return[...i,...a]})}return r.exports.useEffect(()=>{s!==l.current&&(c([[]]),l.current=s),u(!0);const a=R(b(N,"chats",s,"messages"),U("date","asc")),i=_(a,o=>{const m=o.docChanges().filter(d=>d.type==="added").map(d=>d.doc.data()).map(d=>({...d,day:d.date.toDate().toDateString(),time:d.date.toDate().toTimeString().slice(0,5)}));h(g(m)),u(!1)},o=>console.log(o));return()=>i()},[s]),[p,t]}function X({user:s,msg:t}){return f("div",{className:s!==t.uid?"sentMsg msg":"receivedMsg msg",children:[s===t.uid||JSON.stringify(t.name),n("span",{className:"timestamp",children:t.time}),t.msg]})}function z({msgGroup:s,user:t}){return f("div",{className:"messagegroup",children:[n("span",{className:"timestamp",children:s[0].day}),s.map(c=>n(X,{msg:c,user:t}))]})}function G({chatID:s}){const[t,c]=r.exports.useState("");async function p(u){var g;u.preventDefault();const l=t;c(""),await q(b(N,"chats",s,"messages"),{date:P.now(),msg:l,uid:(g=k.currentUser)==null?void 0:g.uid})}return n("div",{className:"chat-writer",children:f("form",{onSubmit:p,children:[n("input",{type:"text",value:t,onChange:u=>c(u.target.value),placeholder:"Type your message here"}),n("button",{className:"button primary",type:"submit",children:"Send"})]})})}function H({chatID:s,chatName:t,setOpenChatBox:c}){const[p,u]=W(s),[l,g]=r.exports.useState(!0);return r.exports.useEffect(()=>{var h;l===!0&&((h=document.getElementById("chatBottom"))==null||h.scrollIntoView({behavior:"auto"}))},[u,l]),f("div",{className:"chatbox",children:[f("div",{className:"flex-between",onClick:()=>g(h=>!h),children:[n("div",{children:t}),l&&n("div",{className:"close",onClick:()=>c(!1),children:"X"})]}),l&&f(L,{children:[f("div",{className:"chat-messages",children:[p?"Loading messages":u[0].length!==0&&u.map((h,a)=>{var i;return n(z,{user:((i=k.currentUser)==null?void 0:i.uid)||"unknown",msgGroup:h},a)}),n("div",{id:"chatBottom"})]}),n(G,{chatID:s})]})]})}const K="/images/message-svgrepo-com.svg";function $(){const[s,t]=r.exports.useState(!1),[c,p]=r.exports.useState(!1),{timeout:u}=V(),[l,g]=r.exports.useState([]),[h,a]=r.exports.useState(""),[i,o]=r.exports.useState(""),m=r.exports.useRef(null),d=r.exports.useRef(null);async function I(){const e=R(b(N,"users",w,"chats")),v=await J(e);let y=[];v.forEach(x=>{let M=x.data(),T=x.id;y.push({uid:T,chatID:M.chat_id})}),g(y)}async function E(e){var y;if(!C)return;(y=m.current)==null||y.close();const v=l.find(x=>x.uid===e);if(v!==void 0)a(v.chatID),o(C.friends[e]),t(!0);else{console.log("creating new chat document");const x=S(b(N,"chats")).id;await D(S(N,"users",w,"chats",e),{chat_id:x,users:[w,e]}),await D(S(N,"users",e,"chats",w),{chat_id:x,users:[w,e]}),a(x),g(M=>[...M,{uid:e,chatID:x}]),o(C.friends[e]),t(!0)}}function j(e){!C||(a(e.chatID),o(C.friends[e.uid]),t(!0))}function B(){m.current&&typeof m.current.showModal=="function"&&m.current.showModal()}function O(){d.current&&(d.current.classList.add("circle-animate"),u(()=>{var e;return(e=d.current)==null?void 0:e.classList.remove("circle-animate")},700))}function F(){c===!1?(O(),p(!0)):p(!1)}return r.exports.useEffect(()=>{I()},[]),C===void 0?n("div",{children:"Error"}):f(L,{children:[f("div",{id:"friends-list",children:[f("h3",{className:"align-center",onClick:F,children:[n("img",{id:"message-icon",src:K,alt:"messages"}),n("div",{className:"circle",ref:d}),f("span",{children:["\xA0",c?"Chats":"Open Chat"]})]}),c&&f(L,{children:[n("div",{className:"highlight secondary",onClick:B,children:"New Chat"}),f("dialog",{className:"modal",ref:m,children:[n("h3",{children:"Friends"}),typeof C.friends=="object"&&Object.keys(C.friends).map((e,v)=>n("div",{className:"highlight",onClick:()=>E(e),children:C.friends[e]},v)),n("button",{value:"cancel",onClick:()=>{var e;return(e=m.current)==null?void 0:e.close()},children:"Cancel"})]}),typeof C.friends=="object"&&l.length>0&&l.map((e,v)=>n("div",{className:"highlight",onClick:()=>j(e),children:C.friends[e.uid]},v))]})]}),s&&n(H,{chatID:h,chatName:i,setOpenChatBox:t})]})}export{$ as default};
