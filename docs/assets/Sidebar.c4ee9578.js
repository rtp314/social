import{z as j,D as z,T as S,H as B,Q as H,y as J,A as D,O as V,J as W,U as E}from"./firestore.464e6c78.js";import{r as d,d as b,j as m,a as n,b as k,F as U,o as X}from"./index.d885ea9e.js";import{a as O,b as $}from"./userData.48b9affd.js";function G(t){const[s,l]=d.exports.useState([[]]),[p,a]=d.exports.useState(!0),h=d.exports.useRef();function g(r){if(r.length===0)return[[]];const i=[[r[0]]];let f=0;return r.forEach((o,u)=>{u!==0&&(o.day===i[f][0].day?i[f].push(o):(f++,i.push([o])))}),i}function c(r){r[0].length!==0&&l(i=>{if(i[0][0]===void 0)return r;if(r[0][0].day===i[i.length-1][0].day){const f=[...i];return f[f.length-1].push(...r[0]),f.push(...r.slice(1)),f}else return[...i,...r]})}return d.exports.useEffect(()=>{t!==h.current&&(l([[]]),h.current=t),a(!0);const r=j(S(b,"chats",t,"messages"),z("date","asc")),i=B(r,f=>{const o=f.docChanges().filter(u=>u.type==="added").map(u=>u.doc.data()).map(u=>({...u,day:u.date.toDate().toDateString(),time:u.date.toDate().toTimeString().slice(0,5)}));c(g(o)),a(!1)},f=>console.log(f));return()=>i()},[t]),[p,s]}function K({user:t,msg:s}){return m("div",{className:t!==s.uid?"sentMsg msg":"receivedMsg msg",children:[n("span",{className:"timestamp",children:s.time}),s.msg]})}function Y({msgGroup:t,user:s}){return m("div",{className:"messagegroup",children:[n("span",{className:"timestamp",children:t[0].day}),t.map((l,p)=>n(K,{msg:l,user:s},p))]})}function Z({chatID:t}){const[s,l]=d.exports.useState("");async function p(a){var g;a.preventDefault();const h=s;l(""),await H(S(b,"chats",t,"messages"),{date:J.now(),msg:h,uid:(g=k.currentUser)==null?void 0:g.uid})}return n("div",{className:"chat-writer",children:m("form",{onSubmit:p,children:[n("input",{type:"text",value:s,onChange:a=>l(a.target.value),placeholder:"Type your message here"}),n("button",{className:"button primary",type:"submit",children:"Send"})]})})}function A({chatID:t,chatName:s,setOpenChatBox:l}){const[p,a]=G(t),[h,g]=d.exports.useState(!0);return d.exports.useEffect(()=>{var c;h===!0&&((c=document.getElementById("chatBottom"))==null||c.scrollIntoView({behavior:"auto"}))},[a,h]),m("div",{className:"chatbox",children:[m("div",{className:"flex-between",onClick:()=>g(c=>!c),children:[n("div",{children:s}),h&&n("div",{className:"close",onClick:()=>l(!1),children:"X"})]}),h&&m(U,{children:[m("div",{className:"chat-messages",children:[p?"Loading messages":a[0].length!==0&&a.map((c,r)=>{var i;return n(Y,{user:((i=k.currentUser)==null?void 0:i.uid)||"unknown",msgGroup:c},r)}),n("div",{id:"chatBottom"})]}),n(Z,{chatID:t})]})]})}const ee=O.getState().setUserData;let L,w,I,y=[];X(k,t=>{if(console.log("auth state changed"),t){w=t.uid;const s=D(b,"users",t.uid);L=B(s,te)}else L&&(L(),console.log("unsubscribed to user data"))});async function te(t){const s=t.data(),l=s.friends;if(y.length===0?y=l:l.forEach(a=>{y.includes(a)||y.push(a)}),y.length===0||y[0]==="")return;console.log(y);const p={};try{await Promise.all(y.map(a=>new Promise((h,g)=>{try{const c=D(b,`users/${a}`);V(c).then(r=>r.get("email")).then(r=>{p[a]=r,h()})}catch(c){console.error("Error fetching friend details"),console.error(c),g()}})))}catch(a){console.error(a)}I={...s,friends:p},ee(I)}const se="/assets/message-svgrepo-com.14f789ac.svg";function ce(){const[t,s]=d.exports.useState(!1),[l,p]=d.exports.useState(!1),[a,h]=d.exports.useState([]),g=d.exports.useRef(""),c=d.exports.useRef(""),[r,i]=d.exports.useState(!0),{timeout:f}=$(),o=O(e=>e.userData),u=d.exports.useRef(null),N=d.exports.useRef(null);async function R(){const e=j(S(b,"users",w,"chats")),x=await W(e);let v=[];x.forEach(C=>{let M=C.data(),Q=C.id;v.push({uid:Q,chatID:M.chat_id})}),h(v)}async function F(e){var v;if(!o)return;(v=u.current)==null||v.close();const x=a.find(C=>C.uid===e);if(x!==void 0)g.current=x.chatID,c.current=o.friends[e],s(!0);else{console.log("creating new chat document");const C=D(S(b,"chats")).id;await E(D(b,"users",w,"chats",e),{chat_id:C,users:[w,e]}),await E(D(b,"users",e,"chats",w),{chat_id:C,users:[w,e]}),g.current=C,h(M=>[...M,{uid:e,chatID:C}]),c.current=o.friends[e],s(!0)}}function T(e){!o||(g.current=e.chatID,c.current=o.friends[e.uid],s(!0))}function _(){u.current&&typeof u.current.showModal=="function"&&u.current.showModal()}function q(){N.current&&(N.current.classList.add("circle-animate"),f(()=>{var e;return(e=N.current)==null?void 0:e.classList.remove("circle-animate")},700))}function P(){l===!1?(q(),p(!0)):p(!1)}return d.exports.useEffect(()=>{R()},[]),o?m(U,{children:[m("div",{id:"friends-list",children:[m("h3",{className:"align-center",onClick:P,children:[n("img",{id:"message-icon",src:se,alt:"messages"}),n("div",{className:"circle",ref:N}),m("span",{children:["\xA0",l?"Chats":"Open Chat"]})]}),l&&m(U,{children:[n("div",{className:"highlight secondary",onClick:_,children:"New Chat"}),m("dialog",{className:"modal",ref:u,children:[n("h3",{children:"Friends"}),typeof o.friends=="object"&&Object.keys(o.friends).map((e,x)=>n("div",{className:"highlight",onClick:()=>F(e),children:o.friends[e]},x)),n("button",{value:"cancel",onClick:()=>{var e;return(e=u.current)==null?void 0:e.close()},children:"Cancel"})]}),typeof o.friends=="object"&&a.length>0&&a.map((e,x)=>n("div",{className:"highlight",onClick:()=>T(e),children:o.friends[e.uid]},x))]})]}),t&&n(A,{chatID:g.current,chatName:c.current,setOpenChatBox:s})]}):m("div",{children:["Error",n("br",{}),n("button",{onClick:()=>i(e=>!e),children:"Retry"})]})}export{ce as default};
